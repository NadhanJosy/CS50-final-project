{% extends "layout.html" %}

{% block title %}Diagnostic Chat{% endblock %}

{% block extra_head %}
<style>
    .welcome-message {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--gray-color);
    }

    .welcome-message i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--primary-color);
        opacity: 0.5;
    }

    .quick-example {
        background: #e7f1ff;
        border-left: 3px solid var(--primary-color);
        padding: 0.75rem 1rem;
        margin: 0.5rem 0;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }

    .quick-example:hover {
        background: #cfe2ff;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
    }

    .quick-example i {
        margin-right: 0.5rem;
        color: var(--primary-color);
    }

    .export-btn {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        margin-top: 1rem;
    }

    /* Full-screen styles */
    .fullscreen-toggle {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .fullscreen-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-50%) scale(1.05);
    }

    .fullscreen-mode {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100vw !important;
        margin: 0 !important;
        z-index: 9999 !important;
        border-radius: 0 !important;
    }

    .fullscreen-mode .chat-box {
        height: 100vh !important;
        border-radius: 0 !important;
    }

    /* Hide navbar and footer in fullscreen */
    body.fullscreen-active nav,
    body.fullscreen-active footer,
    body.fullscreen-active .disclaimer-banner {
        display: none !important;
    }

    body.fullscreen-active {
        overflow: hidden;
    }

    /* Enhanced example cards */
    .examples-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-top: 1rem;
    }

    @media (max-width: 768px) {
        .examples-grid {
            grid-template-columns: 1fr;
        }
    }

    .example-card {
        background: white;
        border: 2px solid #e7f1ff;
        border-radius: 0.75rem;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .example-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
    }

    .example-card .example-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    .example-card .example-title {
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.5rem;
        color: var(--dark-color);
    }

    .example-card .example-description {
        font-size: 0.875rem;
        color: var(--gray-color);
        margin-bottom: 0.75rem;
    }

    .example-card .example-badge {
        display: inline-block;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        background: #e7f1ff;
        color: var(--primary-color);
        font-weight: 600;
    }
</style>
{% endblock %}

{% block main %}
<div class="chat-container" id="chatContainer">
    <div class="chat-box">
        <!-- Chat Header -->
        <div class="chat-header" style="position: relative;">
            <div>
                <h3>
                    <i class="fas fa-stethoscope"></i>
                    AI Diagnostic Assistant
                </h3>
                <p>Describe symptoms to receive differential diagnosis with confidence levels</p>
            </div>
            <button class="fullscreen-toggle" id="fullscreenBtn" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i>
                <span id="fullscreenText">Full Screen</span>
            </button>
        </div>

        <!-- Chat Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome Message -->
            <div class="welcome-message" id="welcomeMessage">
                <i class="fas fa-heartbeat"></i>
                <h4>Welcome to the Clinical Decision Support System</h4>
                <p class="mb-4">Enter patient symptoms below or try one of these example cases</p>

                <div class="container" style="max-width: 700px;">
                    <h6 class="text-start mb-3">
                        <i class="fas fa-lightbulb text-warning"></i>
                        <strong>Example Clinical Cases</strong> - Click any card to try:
                    </h6>

                    <div class="examples-grid">
                        <!-- Example 1: Meningitis (CONFIRMED WORKING) -->
                        <div class="example-card" onclick="useExample('22-year-old presenting with severe headache, high fever (39.5Â°C), stiff neck, photophobia, and confusion. Symptoms started 12 hours ago and are rapidly worsening.')">
                            <span class="example-icon">ðŸ§ </span>
                            <div class="example-title">Meningitis Presentation</div>
                            <div class="example-description">
                                Severe headache, high fever, neck stiffness, photophobia, altered mental status
                            </div>
                            <span class="example-badge">EMERGENCY</span>
                        </div>

                        <!-- Example 2: Appendicitis (CONFIRMED WORKING) -->
                        <div class="example-card" onclick="useExample('28-year-old with abdominal pain that started around the umbilicus and migrated to right lower quadrant. Pain is sharp, constant, with nausea, vomiting, and loss of appetite. Rebound tenderness on examination.')">
                            <span class="example-icon">ðŸ”´</span>
                            <div class="example-title">Appendicitis Classic</div>
                            <div class="example-description">
                                Migrating RLQ pain, rebound tenderness, nausea, vomiting, loss of appetite
                            </div>
                            <span class="example-badge">URGENT</span>
                        </div>
                    </div>

                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle"></i>
                        <strong>Tip:</strong> For best results, include patient age, symptom duration, severity, and any relevant examination findings.
                    </div>
                </div>
            </div>

            <!-- Messages will appear here dynamically -->
        </div>

        <!-- Chat Input -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea
                    class="form-control chat-input"
                    id="chatInput"
                    placeholder="Describe patient symptoms... (e.g., 'Patient has high fever, headache, body pain, and fatigue')"
                    rows="2"></textarea>
                <button class="btn btn-primary chat-send-btn" id="sendBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                    Diagnose
                </button>
            </div>
            <div class="text-muted small mt-2">
                <i class="fas fa-info-circle"></i>
                <strong>Tip:</strong> Include as many symptoms as possible for better accuracy.
                Press Ctrl+Enter to send.
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let conversationHistory = [];
let isProcessing = false;
let isFullscreen = false;

// Full-screen functionality
function toggleFullscreen() {
    const container = document.getElementById('chatContainer');
    const btn = document.getElementById('fullscreenBtn');
    const btnText = document.getElementById('fullscreenText');
    const btnIcon = btn.querySelector('i');

    isFullscreen = !isFullscreen;

    if (isFullscreen) {
        container.classList.add('fullscreen-mode');
        document.body.classList.add('fullscreen-active');
        btnIcon.className = 'fas fa-compress';
        btnText.textContent = 'Exit Full Screen';
    } else {
        container.classList.remove('fullscreen-mode');
        document.body.classList.remove('fullscreen-active');
        btnIcon.className = 'fas fa-expand';
        btnText.textContent = 'Full Screen';
    }
}

// ESC key to exit fullscreen
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isFullscreen) {
        toggleFullscreen();
    }
});

// Auto-resize textarea
document.getElementById('chatInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// Ctrl+Enter to send
document.getElementById('chatInput').addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});

// Use example function
function useExample(text) {
    document.getElementById('chatInput').value = text;
    document.getElementById('chatInput').focus();

    // Smooth animation
    const input = document.getElementById('chatInput');
    input.style.transform = 'scale(1.02)';
    setTimeout(() => {
        input.style.transform = 'scale(1)';
    }, 200);

    // Auto-send after short delay
    setTimeout(() => sendMessage(), 500);
}

// Send message function
async function sendMessage() {
    const input = document.getElementById('chatInput');
    const query = input.value.trim();

    if (!query || isProcessing) {
        return;
    }

    // Hide welcome message
    const welcomeMsg = document.getElementById('welcomeMessage');
    if (welcomeMsg) {
        welcomeMsg.style.display = 'none';
    }

    // Disable input
    isProcessing = true;
    input.disabled = true;
    document.getElementById('sendBtn').disabled = true;

    // Add user message
    addUserMessage(query);

    // Clear input
    input.value = '';
    input.style.height = 'auto';

    // Show typing indicator
    addTypingIndicator();

    try {
        // Call API
        const response = await fetch('/api/diagnose', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query })
        });

        const data = await response.json();

        // Remove typing indicator
        removeTypingIndicator();

        if (data.success) {
            // Add diagnosis response
            addDiagnosisMessage(data);

            // Store in history
            conversationHistory.push({
                query: query,
                response: data,
                timestamp: new Date().toISOString()
            });
        } else {
            // Add error message
            addErrorMessage(data.error || 'Failed to generate diagnosis');
        }

    } catch (error) {
        console.error('Error:', error);
        removeTypingIndicator();
        addErrorMessage('Network error. Please try again.');
    } finally {
        // Re-enable input
        isProcessing = false;
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        input.focus();
    }
}

// Add user message to chat
function addUserMessage(text) {
    const messagesDiv = document.getElementById('chatMessages');
    const timestamp = new Date().toLocaleTimeString();

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message message-user';
    messageDiv.innerHTML = `
        <div class="message-content">
            <div>${escapeHtml(text)}</div>
            <span class="message-timestamp">${timestamp}</span>
        </div>
    `;

    messagesDiv.appendChild(messageDiv);
    scrollToBottom();
}

// Add typing indicator
function addTypingIndicator() {
    const messagesDiv = document.getElementById('chatMessages');

    const typingDiv = document.createElement('div');
    typingDiv.className = 'message message-assistant';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div class="message-content">
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="text-muted small">Analyzing symptoms...</div>
        </div>
    `;

    messagesDiv.appendChild(typingDiv);
    scrollToBottom();
}

// Remove typing indicator
function removeTypingIndicator() {
    const typingDiv = document.getElementById('typingIndicator');
    if (typingDiv) {
        typingDiv.remove();
    }
}

// Add diagnosis message
function addDiagnosisMessage(data) {
    const messagesDiv = document.getElementById('chatMessages');
    const timestamp = new Date().toLocaleTimeString();

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message message-assistant';

    // Build diagnosis HTML
    let html = `<div class="message-content">`;

    // Top diagnosis
    html += `
        <div class="diagnosis-card">
            <div class="diagnosis-header">
                <h5 class="diagnosis-title">
                    <i class="fas fa-diagnoses text-primary"></i>
                    Top Diagnosis
                </h5>
                <span class="confidence-badge confidence-${data.confidence_level}">
                    ${data.confidence_level} Confidence
                </span>
            </div>

            <div class="alert alert-primary mb-3">
                <h4 class="mb-0">
                    <i class="fas fa-stethoscope"></i>
                    ${escapeHtml(data.top_diagnosis)}
                </h4>
                <div class="mt-2">
                    <strong>Probability:</strong> ${(data.top_probability * 100).toFixed(1)}%
                </div>
            </div>
    `;

    // Symptoms detected
    if (data.symptoms_list && data.symptoms_list.length > 0) {
        html += `
            <div class="symptoms-detected">
                <h6>
                    <i class="fas fa-check-circle"></i>
                    Symptoms Detected (${data.symptoms_detected})
                </h6>
                <div>
        `;
        data.symptoms_list.forEach(symptom => {
            html += `<span class="symptom-tag">${escapeHtml(symptom)}</span>`;
        });
        html += `</div></div>`;
    }

    // Urgent warning
    if (data.is_urgent) {
        html += `
            <div class="urgent-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>URGENT:</strong> This condition may require immediate medical attention
            </div>
        `;
    }

    // Differential diagnosis
    html += `
        <div class="differential-list">
            <h6 class="mt-3 mb-2">
                <i class="fas fa-list-ol"></i>
                Differential Diagnosis
            </h6>
    `;

    data.differential_diagnosis.slice(0, 5).forEach((item, index) => {
        const rankClass = index < 3 ? `rank-${index + 1}` : '';
        html += `
            <div class="differential-item ${rankClass}">
                <div class="differential-header">
                    <div>
                        <span class="badge bg-secondary me-2">#${index + 1}</span>
                        <span class="disease-name">${escapeHtml(item.disease)}</span>
                    </div>
                    <span class="disease-probability text-primary">
                        ${(item.probability * 100).toFixed(1)}%
                    </span>
                </div>
                <div class="probability-bar">
                    <div class="probability-fill" style="width: ${item.probability * 100}%"></div>
                </div>
        `;

        if (item.supporting_symptoms && item.supporting_symptoms.length > 0) {
            html += `
                <div class="supporting-symptoms">
                    <strong>Key symptoms:</strong>
                    ${item.supporting_symptoms.slice(0, 3).map(s => escapeHtml(s)).join(', ')}
                </div>
            `;
        }

        html += `</div>`;
    });

    html += `</div>`;

    // Recommendations
    if (data.recommendations && data.recommendations.length > 0) {
        html += `
            <div class="recommendations-section">
                <h6>
                    <i class="fas fa-clipboard-check"></i>
                    Clinical Recommendations
                </h6>
        `;
        data.recommendations.forEach(rec => {
            html += `<div class="recommendation-item">${escapeHtml(rec)}</div>`;
        });
        html += `</div>`;
    }

    // Warnings
    if (data.warnings && data.warnings.length > 0) {
        html += `<div class="mt-3 alert alert-warning mb-0">`;
        data.warnings.forEach(warning => {
            html += `<div>${escapeHtml(warning)}</div>`;
        });
        html += `</div>`;
    }

    // Export button
    if (data.consultation_id) {
        html += `
            <div class="text-center">
                <a href="/consultation/${data.consultation_id}"
                   class="btn btn-sm btn-outline-primary export-btn"
                   target="_blank">
                    <i class="fas fa-external-link-alt"></i>
                    View Full Report
                </a>
                <a href="/export/${data.consultation_id}"
                   class="btn btn-sm btn-outline-secondary export-btn">
                    <i class="fas fa-download"></i>
                    Export JSON
                </a>
            </div>
        `;
    }

    html += `</div>`;
    html += `<span class="message-timestamp">${timestamp}</span>`;
    html += `</div>`;

    messageDiv.innerHTML = html;
    messagesDiv.appendChild(messageDiv);
    scrollToBottom();
}

// Add error message
function addErrorMessage(errorText) {
    const messagesDiv = document.getElementById('chatMessages');
    const timestamp = new Date().toLocaleTimeString();

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message message-assistant';
    messageDiv.innerHTML = `
        <div class="message-content">
            <div class="alert alert-danger mb-0">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Error:</strong> ${escapeHtml(errorText)}
            </div>
            <span class="message-timestamp">${timestamp}</span>
        </div>
    `;

    messagesDiv.appendChild(messageDiv);
    scrollToBottom();
}

// Utility: Scroll to bottom
function scrollToBottom() {
    const messagesDiv = document.getElementById('chatMessages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Utility: Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize
document.getElementById('chatInput').focus();
</script>
{% endblock %}
